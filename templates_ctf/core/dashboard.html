{% extends 'ctf_base.html' %}
{% load static %}

{% block title %}Dashboard - CYBER SENTINELS CTF{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-950 via-red-950 to-gray-950" data-dashboard>
    <!-- Header Section -->
    <div class="bg-black/50 border-b border-primary/30 backdrop-blur-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
<h1 class="text-4xl font-jetbrains font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-400 mb-2">
                DASHBOARD
            </h1>
            {% if current_event %}
                <p class="text-gray-400">
                    Event: <span class="text-primary font-semibold">{{ current_event.name }}</span>
                    {% if current_event.contest_state == 'stopped' %}
                        <span class="inline-block ml-4 px-3 py-1 bg-red-500/30 border border-red-600 rounded text-red-300 text-sm font-bold">
                            üõë EVENT STOPPED
                        </span>
                    {% elif current_event.contest_state == 'paused' %}
                        <span class="inline-block ml-4 px-3 py-1 bg-yellow-500/20 border border-yellow-500/50 rounded text-yellow-400 text-sm font-bold animate-pulse">
                            ‚è∏Ô∏è PAUSED
                        </span>
                    {% elif current_event.is_running %}
                        <span class="inline-block ml-4 px-3 py-1 bg-green-500/20 border border-green-500/50 rounded text-green-400 text-sm">
                            üü¢ LIVE
                        </span>
                    {% else %}
                        <span class="inline-block ml-4 px-3 py-1 bg-gray-500/20 border border-gray-500/50 rounded text-gray-400 text-sm">
                            ‚è±Ô∏è {{ current_event.get_contest_state_display }}
                        </span>
                    {% endif %}
                </p>
            {% else %}
                <p class="text-gray-400">No active event at this time</p>
            {% endif %}
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Ban Warning -->
        {% if is_team_banned %}
            <div class="mb-6 p-4 bg-red-950/50 border-2 border-red-600 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="text-3xl">üö´</div>
                    <div>
                        <h3 class="text-xl font-bold text-red-400">Team Banned</h3>
                        <p class="text-red-300 mt-1">{{ ban_reason }}</p>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if not current_event %}
            <div class="text-center py-12">
                <p class="text-gray-400 text-lg mb-4">No active event currently running</p>
                <a href="/dojo/" class="inline-block px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded transition">
                    Return to Home
                </a>
            </div>
        {% elif not user_team %}
            <div class="text-center py-12 bg-gradient-to-br from-gray-900/90 to-gray-800/90 border border-primary/30 rounded-lg p-12">
                <div class="mb-6">
                    <div class="text-6xl mb-4">üë•</div>
                    <h2 class="text-2xl font-bold text-primary mb-2">Join or Create a Team</h2>
                    <p class="text-gray-400 text-lg mb-6">You need to be part of a team to participate in the CTF</p>
                </div>
                <div class="flex gap-4 justify-center">
                    <a href="/dojo/teams/" class="inline-block px-8 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition font-semibold">
                        Browse Teams
                    </a>
                    <a href="/dojo/teams/create/" class="inline-block px-8 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition font-semibold">
                        Create Team
                    </a>
                </div>
            </div>
        {% else %}
            <!-- Event Paused Warning -->
            {% if current_event.contest_state == 'paused' %}
            <div class="mb-8 p-6 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-2 border-yellow-500/50 rounded-lg">
                <div class="flex items-center gap-4">
                    <div class="text-4xl">‚è∏Ô∏è</div>
                    <div>
                        <h3 class="text-xl font-bold text-yellow-400 mb-1">Event is Currently PAUSED</h3>
                        <p class="text-yellow-200">Flag submissions are temporarily disabled. The event will resume soon.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Team Score Card -->
                <div class="bg-gradient-to-br from-red-500/10 to-orange-500/10 border border-red-500/30 rounded-lg p-6 hover:border-red-500/60 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-semibold">TEAM SCORE</p>
                            <h2 class="text-4xl font-bold text-red-400 mt-2" data-stat="score">{{ total_score|default:"0" }}</h2>
                            <p class="text-gray-500 text-xs mt-1">Rank: <span class="text-red-400 font-bold" data-stat="rank">#{{ team_rank|default:"‚Äî" }}</span></p>
                        </div>
                        <div class="text-5xl">üèÜ</div>
                    </div>
                </div>

                <!-- Challenges Solved Card -->
                <div class="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/30 rounded-lg p-6 hover:border-green-500/60 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-semibold">CHALLENGES SOLVED</p>
                            <h2 class="text-4xl font-bold text-green-400 mt-2" data-stat="solved">{{ solved_count|default:"0" }}</h2>
                            <p class="text-gray-500 text-xs mt-1">of {{ event_stats.total_challenges }} available</p>
                        </div>
                        <div class="text-5xl">‚úì</div>
                    </div>
                </div>
                <!-- Event Stats Card -->
                <div class="bg-gradient-to-br from-yellow-500/10 to-orange-500/10 border border-yellow-500/30 rounded-lg p-6 hover:border-yellow-500/60 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-semibold">EVENT PROGRESS</p>
                            <h2 class="text-2xl font-bold text-yellow-400 mt-2">{{ event_stats.correct_submissions }}</h2>
                            <p class="text-gray-500 text-xs mt-1">Correct submissions across all teams</p>
                        </div>
                        <div class="text-5xl">üìä</div>
                    </div>
                </div>

                <!-- Team Members Card -->
                <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-lg p-6 hover:border-purple-500/60 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm font-semibold">TEAM MEMBERS</p>
                            <h2 class="text-4xl font-bold text-purple-400 mt-2" data-stat="members">{{ user_team.member_count|default:"0" }}</h2>
                            <p class="text-gray-500 text-xs mt-1">Active members</p>
                        </div>
                        <div class="text-5xl">üë•</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Countdown + Challenge Breakdown -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Event Countdown Timer -->
                    <div class="bg-gradient-to-br from-orange-900/30 to-red-900/30 border border-orange-500/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-orange-400 mb-4">‚è±Ô∏è Event Countdown</h3>
                        <div id="countdown-display" class="text-center p-6 bg-black/40 rounded-lg border border-orange-500/50">
                            <div class="text-5xl font-bold text-orange-400 font-mono" id="countdown-timer">
                                {% if current_event.end_time %}
                                    {{ current_event.end_time|timeuntil }}
                                {% else %}
                                    No End Time
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-400 mt-3">Time remaining until event ends</p>
                        </div>
                        <script>
                            function updateCountdown() {
                                const endTime = new Date("{{ current_event.end_time|date:'c' }}").getTime();
                                const timerEl = document.getElementById('countdown-timer');
                                const countdownDisplay = document.getElementById('countdown-display');
                                
                                if (!endTime) return;
                                
                                const interval = setInterval(() => {
                                    const now = new Date().getTime();
                                    const distance = endTime - now;
                                    
                                    if (distance < 0) {
                                        clearInterval(interval);
                                        timerEl.textContent = 'Event Ended!';
                                        countdownDisplay.classList.remove('border-orange-500/50', 'bg-black/40');
                                        countdownDisplay.classList.add('border-red-500/50', 'bg-red-900/20');
                                        return;
                                    }
                                    
                                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                                    
                                    timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                    
                                    // Change color based on time remaining
                                    if (distance < 1800000) { // Less than 30 minutes
                                        timerEl.classList.add('text-red-400');
                                        timerEl.classList.remove('text-orange-400');
                                        countdownDisplay.classList.add('border-red-500/50', 'bg-red-900/10');
                                        countdownDisplay.classList.remove('border-orange-500/50', 'bg-black/40');
                                    } else if (distance < 3600000) { // Less than 60 minutes
                                        timerEl.classList.add('text-yellow-400');
                                        timerEl.classList.remove('text-orange-400', 'text-red-400');
                                        countdownDisplay.classList.add('border-yellow-500/50', 'bg-yellow-900/10');
                                        countdownDisplay.classList.remove('border-orange-500/50', 'border-red-500/50', 'bg-black/40', 'bg-red-900/10');
                                    }
                                }, 1000);
                            }
                            updateCountdown();
                        </script>
                    </div>
<!-- 
                    <div class="bg-gradient-to-br from-purple-900/30 to-pink-900/30 border border-purple-500/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-purple-400 mb-4">üìä Challenge Progress by Category</h3>
                        <div class="space-y-4">
                            {% if category_stats %}
                                {% for cat in category_stats %}
                                    <div class="bg-black/40 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-white font-semibold">{{ cat.name }}</span>
                                            <span class="text-purple-400 font-bold">{{ cat.solved }}/{{ cat.total }}</span>
                                        </div>
                                        <div class="w-full bg-gray-900 rounded-full h-3 overflow-hidden border border-purple-500/30">
                                            {% if cat.total > 0 %}
                                                <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all" style="width: {{ cat.percentage }}%"></div>
                                            {% endif %}
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">{{ cat.percentage|floatformat:0 }}% Complete</p>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-400 text-center py-6">Loading category statistics...</p>
                            {% endif %}
                        </div>
                    </div> -->

                    <!-- Team Member Activity -->
                    <div class="bg-gradient-to-br from-cyan-900/30 to-blue-900/30 border border-cyan-500/30 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-cyan-400 mb-4">üë• Team Member Activity</h3>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            {% if team_member_activity %}
                                {% for activity in team_member_activity %}
                                    <div class="bg-black/40 border border-cyan-500/20 rounded-lg p-3 hover:border-cyan-500/50 transition">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <p class="text-sm font-semibold text-white">
                                                    {% if activity.type == 'solve' %}
                                                        ‚úì <span class="text-green-400">{{ activity.member_name }} solved</span> {{ activity.challenge_name }}
                                                    {% elif activity.type == 'attempt' %}
                                                        üîÑ <span class="text-yellow-400">{{ activity.member_name }} attempted</span> {{ activity.challenge_name }}
                                                    {% elif activity.type == 'hint' %}
                                                        üí° <span class="text-blue-400">{{ activity.member_name }} unlocked hint</span> for {{ activity.challenge_name }}
                                                    {% endif %}
                                                </p>
                                                <p class="text-xs text-gray-500 mt-1">{{ activity.timestamp|timesince }} ago</p>
                                            </div>
                                            {% if activity.type == 'solve' %}
                                                <span class="text-lg">üî•</span>
                                            {% elif activity.type == 'attempt' %}
                                                <span class="text-lg"></span>
                                            {% else %}
                                                <span class="text-lg">üîë</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-400 text-center py-6">No team activity yet</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Right Column: Challenges + Scoreboard -->
                <div class="space-y-8">
                    <!-- Available Challenges Section -->
                    <!-- <div class="bg-black/30 border border-cyan-500/20 rounded-lg overflow-hidden backdrop-blur-sm">
                        <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border-b border-cyan-500/30 px-6 py-4">
                            <h3 class="text-xl font-bold text-cyan-400 flex items-center">
                                <span class="inline-block w-2 h-2 bg-cyan-400 rounded-full mr-3 animate-pulse"></span>
                                Available Challenges
                            </h3>
                        </div>
                        <div class="p-6">
                            {% if active_challenges %}
                                <div class="space-y-4">
                                    {% for challenge in active_challenges %}
                                        <div class="bg-gray-900/50 border border-gray-700/50 rounded p-4 hover:border-cyan-500/50 transition group cursor-pointer">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-3">
                                                        <span class="px-3 py-1 bg-{{ challenge.category.color|default:'blue' }}-500/20 border border-{{ challenge.category.color|default:'blue' }}-500/50 rounded text-xs text-{{ challenge.category.color|default:'blue' }}-400 font-semibold">
                                                            {{ challenge.category.name }}
                                                        </span>
                                                        <h4 class="text-lg font-semibold text-white group-hover:text-cyan-400 transition">
                                                            {{ challenge.name }}
                                                        </h4>
                                                    </div>
                                                    <p class="text-gray-400 text-sm mt-2 line-clamp-2">{{ challenge.description }}</p>
                                                </div>
                                                <div class="text-right ml-4">
                                                    <p class="text-2xl font-bold text-yellow-400">{{ challenge.points }}</p>
                                                    <p class="text-xs text-gray-500">pts</p>
                                                </div>
                                            </div>
                                            <div class="mt-3 flex justify-end gap-2">
                                                {% if challenge.instance_based %}
                                                    <a href="#" class="px-3 py-1 bg-purple-500/20 border border-purple-500/50 text-purple-400 text-xs rounded hover:bg-purple-500/30 transition">
                                                        Start Instance
                                                    </a>
                                                {% endif %}
                                                <a href="#" class="px-3 py-1 bg-cyan-500/20 border border-cyan-500/50 text-cyan-400 text-xs rounded hover:bg-cyan-500/30 transition">
                                                    View Details
                                                </a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-400 text-center py-8">No challenges available at this time</p>
                            {% endif %}
                        </div>
                    </div> -->
                    <!-- Scoreboard Section -->
                    <div class="bg-black/30 border border-yellow-500/20 rounded-lg overflow-hidden backdrop-blur-sm">
                        <div class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-b border-yellow-500/30 px-6 py-4">
                            <h3 class="text-xl font-bold text-yellow-400 flex items-center">
                                <span class="inline-block w-2 h-2 bg-yellow-400 rounded-full mr-3 animate-pulse"></span>
                                Top Teams
                            </h3>
                        </div>
                        <div class="p-6" data-component="scoreboard">
                            {% if top_teams %}
                                <div class="space-y-3">
                                    {% for entry in top_teams %}
                                        <div class="flex items-center justify-between p-3 rounded {% if entry.team.id == user_team.id %}bg-cyan-500/10 border border-cyan-500/30{% else %}bg-gray-900/50 border border-gray-700/50{% endif %} hover:border-yellow-500/50 transition">
                                            <div class="flex items-center gap-3">
                                                <span class="text-xl font-bold w-6 h-6 flex items-center justify-center bg-yellow-500/20 rounded">
                                                    {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% else %}{{ forloop.counter }}{% endif %}
                                                </span>
                                                <span class="font-semibold {% if entry.team.id == user_team.id %}text-cyan-400{% else %}text-white{% endif %}">
                                                    {{ entry.team.name }}
                                                </span>
                                            </div>
                                            <span class="text-yellow-400 font-bold">{{ entry.score }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-400 text-center py-8">No teams have scored yet</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Recent Activity Section -->
                    <div class="bg-black/30 border border-green-500/20 rounded-lg overflow-hidden backdrop-blur-sm">
                        <div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-b border-green-500/30 px-6 py-4">
                            <h3 class="text-xl font-bold text-green-400 flex items-center">
                                <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-3 animate-pulse"></span>
                                Your Activity
                            </h3>
                        </div>
                        <div class="p-6" data-component="activity">
                            {% if recent_submissions %}
                                <div class="space-y-3 max-h-80 overflow-y-auto">
                                    {% for submission in recent_submissions %}
                                        <div class="text-sm p-2 rounded {% if submission.status == 'correct' %}bg-green-500/10 border-l-2 border-green-500{% elif submission.status == 'incorrect' %}bg-red-500/10 border-l-2 border-red-500{% else %}bg-gray-900/50 border-l-2 border-gray-700{% endif %}">
                                            <div class="flex items-start justify-between">
                                                <div>
                                                    <p class="font-semibold {% if submission.status == 'correct' %}text-green-400{% elif submission.status == 'incorrect' %}text-red-400{% else %}text-gray-400{% endif %}">
                                                        {{ submission.challenge.name }}
                                                    </p>
                                                    <p class="text-xs text-gray-500 mt-1">
                                                        {% if submission.status == 'correct' %}‚úì Correct{% elif submission.status == 'incorrect' %}‚úó Incorrect{% else %}{{ submission.get_status_display }}{% endif %}
                                                    </p>
                                                </div>
                                                <span class="text-xs text-gray-500">{{ submission.timestamp|timesince }} ago</span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-400 text-center py-8">No submissions yet</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Team Info Section -->
                    <!-- <div class="bg-black/30 border border-blue-500/20 rounded-lg overflow-hidden backdrop-blur-sm">
                        <div class="bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-b border-blue-500/30 px-6 py-4">
                            <h3 class="text-xl font-bold text-blue-400">Team Information</h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Team Name</p>
                                <p class="text-lg font-semibold text-white mt-1">{{ user_team.name }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Members</p>
                                <p class="text-sm text-gray-400 mt-1">{{ user_team.get_member_count }} active members</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Captain</p>
                                <p class="text-sm text-gray-400 mt-1">{{ user_team.captain.username }}</p>
                            </div>
                            <a href="#" class="inline-block mt-4 px-4 py-2 w-full text-center bg-blue-500/20 border border-blue-500/50 text-blue-400 rounded hover:bg-blue-500/30 transition text-sm font-semibold">
                                View Team Details
                            </a>
                        </div> -->
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
    @keyframes glow {
        0%, 100% {
            box-shadow: 0 0 5px rgba(34, 211, 238, 0.5);
        }
        50% {
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.8);
        }
    }
    
    .animate-glow {
        animation: glow 2s ease-in-out infinite;
    }
    
    /* Smooth scrolling */
    .max-h-80 {
        scroll-behavior: smooth;
    }
    
    /* Line clamp support */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock %}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
